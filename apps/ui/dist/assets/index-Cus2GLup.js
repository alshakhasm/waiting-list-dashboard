const a={waiting:new Map,schedule:new Map,mappings:new Map,imports:new Map};function f(e="id"){return`${e}_${Math.random().toString(36).slice(2,10)}`}const k={list(){return Array.from(a.mappings.values())},create(e){const t=f("mp"),n={id:t,...e};return a.mappings.set(t,n),n}};function M(){return k.list()}function x(e){return k.create(e)}const N={importExcel(e,t,n){const r=f("imp");let o=0,s=0;const d=0,u=[],p=new Set;for(const c of t){if(!c.patientName||!c.mrn){s++;continue}const I=`${c.patientName}|${c.mrn}`;if(p.has(I)){s++;continue}p.add(I);const w=f("w"),E={id:w,patientName:c.patientName,mrn:c.mrn,caseTypeId:c.caseTypeName??"case:unknown",procedure:c.procedure??"",estDurationMin:c.estDurationMin??0,surgeonId:c.surgeonId,createdAt:new Date().toISOString()};a.waiting.set(w,E),o++}const y={id:r,fileName:e,importedAt:new Date().toISOString(),mappingProfileId:n==null?void 0:n.id,countsCreated:o,countsUpdated:d,countsSkipped:s,errors:u};return a.imports.set(r,y),y}};function A(e,t,n){return N.importExcel(e,t,n)}function v(e){return e?`••••${e.slice(-4)}`:""}const O={list(e){let t=Array.from(a.waiting.values());return e!=null&&e.caseTypeId&&(t=t.filter(n=>n.caseTypeId===e.caseTypeId)),e!=null&&e.surgeonId&&(t=t.filter(n=>n.surgeonId===e.surgeonId)),e!=null&&e.search&&(t=t.filter(n=>(n.patientName+" "+n.procedure).toLowerCase().includes(e.search.toLowerCase()))),t.map(n=>({...n,maskedMrn:v(n.mrn)}))}},P=O.list;function T(e,t,n,r){return!(t<=n||r<=e)}const m={list(e){const t=Array.from(a.schedule.values());return e!=null&&e.date?t.filter(n=>n.date===e.date):t},create(e){const t=Array.from(a.schedule.values()).filter(o=>o.date===e.date);for(const o of t){if(o.roomId===e.roomId&&T(o.startTime,o.endTime,e.startTime,e.endTime))throw new Error("Room unavailable");if(o.surgeonId===e.surgeonId&&T(o.startTime,o.endTime,e.startTime,e.endTime))throw new Error("Surgeon unavailable")}const n=f("sch"),r={id:n,waitingListItemId:e.waitingListItemId,roomId:e.roomId,surgeonId:e.surgeonId,date:e.date,startTime:e.startTime,endTime:e.endTime,status:"scheduled",notes:e.notes,updatedAt:new Date().toISOString(),version:1};return a.schedule.set(n,r),r},update(e,t){const n=a.schedule.get(e);if(!n)throw new Error("Not found");if(t.version!==n.version)throw new Error("Version conflict");const r={...n,...t,version:n.version+1,updatedAt:new Date().toISOString()};return a.schedule.set(e,r),r},cancel(e){const t=a.schedule.get(e);t&&(t.status="cancelled",t.updatedAt=new Date().toISOString(),t.version+=1,a.schedule.set(e,t))}},L=m.create,D=m.update,q=m.cancel,R=m.list,C={week(e){return Array.from(a.waiting.values()).map(t=>({name:t.patientName,maskedMrn:v(t.mrn),caseTypeId:t.caseTypeId,procedure:t.procedure}))}},G=C.week,$={default:{name:"default",palette:{background:"#0f111a",surface:"#161821",text:"#e6e6e6",mutedText:"#a0a3ad",accent:"#7aa2f7",success:"#9ece6a",warning:"#e0af68",danger:"#f7768e",focusOutline:"#c0caf5"},typography:{baseFontSizePx:14,lineHeight:1.5,scaleRatio:1.2}},"high-contrast":{name:"high-contrast",palette:{background:"#000000",surface:"#0a0a0a",text:"#ffffff",mutedText:"#e0e0e0",accent:"#00baff",success:"#37ff8b",warning:"#ffd166",danger:"#ff4d6d",focusOutline:"#ffffff"},typography:{baseFontSizePx:16,lineHeight:1.6,scaleRatio:1.2}}};function B(e){return $[e]}function F(e){const t=B(e).palette;return[{key:"case-elective",label:"Elective",color:t.accent},{key:"case-urgent",label:"Urgent",color:t.warning},{key:"case-emergency",label:"Emergency",color:t.danger},{key:"case-success",label:"Completed",color:t.success}]}function b(e,t){const n=e.split("/").filter(Boolean),r=t.split("/").filter(Boolean);if(n.length!==r.length)return{ok:!1,params:{}};const o={};for(let s=0;s<n.length;s++){const d=n[s],u=r[s];if(d.startsWith(":"))o[d.slice(1)]=decodeURIComponent(u);else if(d!==u)return{ok:!1,params:{}}}return{ok:!0,params:o}}function i(e,t={}){return{status:200,body:e,headers:t}}function g(e){return{status:201,body:e}}function U(){return{status:204}}function l(e){return{status:400,body:{error:e}}}function H(e="Not Found"){return{status:404,body:{error:e}}}function S(e){return{status:409,body:{error:e}}}function h(e){return{status:500,body:{error:e}}}const _=[{method:"GET",pattern:"/mapping-profiles",handler:()=>i(M())},{method:"POST",pattern:"/mapping-profiles",handler:e=>{const t=e.body;if(!t||!t.name||!t.owner||!t.fieldMappings)return l("Missing required fields");const n=x({name:t.name,owner:t.owner,fieldMappings:t.fieldMappings});return g(n)}},{method:"POST",pattern:"/imports/excel",handler:e=>{const t=e.body;if(!t||!t.fileName||!Array.isArray(t.rows))return l("fileName and rows are required");const n=A(t.fileName,t.rows);return g(n)}},{method:"GET",pattern:"/backlog",handler:e=>{const{caseTypeId:t,surgeonId:n,search:r}=e.query||{},o=P({caseTypeId:t,surgeonId:n,search:r});return i(o)}},{method:"GET",pattern:"/schedule",handler:e=>{const{date:t}=e.query||{},n=R(t?{date:t}:void 0);return i(n)}},{method:"POST",pattern:"/schedule",handler:e=>{const t=e.body;if(!t||!t.waitingListItemId||!t.roomId||!t.surgeonId||!t.date||!t.startTime||!t.endTime)return l("Missing required schedule fields");try{const n=L({waitingListItemId:t.waitingListItemId,roomId:t.roomId,surgeonId:t.surgeonId,date:t.date,startTime:t.startTime,endTime:t.endTime,notes:t.notes});return g(n)}catch(n){const r=(n==null?void 0:n.message)||"Error creating schedule";return r.includes("unavailable")?S(r):h(r)}}},{method:"PATCH",pattern:"/schedule/:id",handler:(e,t)=>{const n=t.id,r=e.body;if(!r||typeof r.version!="number")return l("version is required");try{const o=D(n,r);return i(o)}catch(o){const s=(o==null?void 0:o.message)||"Error updating schedule";return s.includes("Not found")?H(s):s.includes("Version conflict")?S(s):h(s)}}},{method:"DELETE",pattern:"/schedule/:id",handler:(e,t)=>(q(t.id),U())},{method:"GET",pattern:"/exports/schedule",handler:e=>{const{date:t=new Date().toISOString().slice(0,10)}=e.query||{},n=G(t);return i(n)}},{method:"GET",pattern:"/legend",handler:e=>{var r;const t=((r=e.query)==null?void 0:r.theme)||"default",n=F(t);return i(n)}}];async function z(e){const t=_.find(r=>r.method===e.method&&b(r.pattern,e.path).ok);if(!t)return{status:404,body:{error:"Route not found"}};const{params:n}=b(t.pattern,e.path);try{return await t.handler(e,n)}catch(r){return h((r==null?void 0:r.message)||"Unknown error")}}export{z as handleRequest};
