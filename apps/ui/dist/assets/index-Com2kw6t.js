const i={waiting:new Map,schedule:new Map,mappings:new Map,imports:new Map};function p(e="id"){return`${e}_${Math.random().toString(36).slice(2,10)}`}const x={list(){return Array.from(i.mappings.values())},create(e){const t=p("mp"),n={id:t,...e};return i.mappings.set(t,n),n}};function O(){return x.list()}function P(e){return x.create(e)}const D={importExcel(e,t,n){const r=p("imp");let s=0,d=0;const c=0,a=[],f=new Set;for(const o of t){if(!o.patientName||!o.mrn){d++;continue}const g=`${o.patientName}|${o.mrn}`;if(f.has(g)){d++;continue}f.add(g);const S=p("w"),L={id:S,patientName:o.patientName,mrn:o.mrn,caseTypeId:o.caseTypeName??"case:unknown",procedure:o.procedure??"",estDurationMin:o.estDurationMin??0,surgeonId:o.surgeonId,createdAt:new Date().toISOString()};i.waiting.set(S,L),s++}const m={id:r,fileName:e,importedAt:new Date().toISOString(),mappingProfileId:n==null?void 0:n.id,countsCreated:s,countsUpdated:c,countsSkipped:d,errors:a};return i.imports.set(r,m),m}};function R(e,t,n){return D.importExcel(e,t,n)}function w(e){return e?`••••${e.slice(-4)}`:""}const b={list(e){let t=Array.from(i.waiting.values());return e!=null&&e.caseTypeId&&(t=t.filter(n=>n.caseTypeId===e.caseTypeId)),e!=null&&e.surgeonId&&(t=t.filter(n=>n.surgeonId===e.surgeonId)),e!=null&&e.search&&(t=t.filter(n=>(n.patientName+" "+n.procedure).toLowerCase().includes(e.search.toLowerCase()))),t.map(n=>({...n,maskedMrn:w(n.mrn)}))},softRemove(e){return i.waiting.has(e)?(i.waiting.delete(e),!0):!1},update(e,t){const n=i.waiting.get(e);if(!n)return null;const r={...n,...t};return i.waiting.set(e,r),{...r,maskedMrn:w(r.mrn)}}},q=b.list,B=b.softRemove,C=b.update;function k(e,t,n,r){return!(t<=n||r<=e)}const I={list(e){const t=Array.from(i.schedule.values());return e!=null&&e.date?t.filter(n=>n.date===e.date):t},create(e){const t=new Date().toISOString().slice(0,10);if(e.date<=t)throw new Error("Scheduled date must be in the future");const n=Array.from(i.schedule.values()),r=n.filter(o=>o.waitingListItemId===e.waitingListItemId),s=r.find(o=>o.status!=="cancelled"),d=r.filter(o=>o.id!==(s==null?void 0:s.id)),c=n.filter(o=>o.date===e.date&&(!s||o.id!==s.id));for(const o of c){if(o.roomId===e.roomId&&k(o.startTime,o.endTime,e.startTime,e.endTime))throw new Error("Room unavailable");if(o.surgeonId===e.surgeonId&&k(o.startTime,o.endTime,e.startTime,e.endTime))throw new Error("Surgeon unavailable")}const a=new Date().toISOString();if(s){for(const g of d)i.schedule.delete(g.id);const o={...s,roomId:e.roomId,surgeonId:e.surgeonId,date:e.date,startTime:e.startTime,endTime:e.endTime,notes:e.notes??s.notes,status:"scheduled",updatedAt:a,version:s.version+1};return i.schedule.set(s.id,o),o}for(const o of d)i.schedule.delete(o.id);const f=p("sch"),m={id:f,waitingListItemId:e.waitingListItemId,roomId:e.roomId,surgeonId:e.surgeonId,date:e.date,startTime:e.startTime,endTime:e.endTime,status:"scheduled",notes:e.notes,updatedAt:a,version:1};return i.schedule.set(f,m),m},update(e,t){const n=i.schedule.get(e);if(!n)throw new Error("Not found");if(t.version!==n.version)throw new Error("Version conflict");const r={...n,...t,version:n.version+1,updatedAt:new Date().toISOString()};return i.schedule.set(e,r),r},cancel(e){const t=i.schedule.get(e);t&&(t.status="cancelled",t.updatedAt=new Date().toISOString(),t.version+=1,i.schedule.set(e,t))}},G=I.create,v=I.update,$=I.cancel,E=I.list,F={week(e){return Array.from(i.waiting.values()).map(t=>({name:t.patientName,maskedMrn:w(t.mrn),caseTypeId:t.caseTypeId,procedure:t.procedure}))}},H=F.week,U={default:{name:"default",palette:{background:"#0f111a",surface:"#161821",text:"#e6e6e6",mutedText:"#a0a3ad",accent:"#7aa2f7",success:"#9ece6a",warning:"#e0af68",danger:"#f7768e",focusOutline:"#c0caf5"},typography:{baseFontSizePx:14,lineHeight:1.5,scaleRatio:1.2}},"high-contrast":{name:"high-contrast",palette:{background:"#000000",surface:"#0a0a0a",text:"#ffffff",mutedText:"#e0e0e0",accent:"#00baff",success:"#37ff8b",warning:"#ffd166",danger:"#ff4d6d",focusOutline:"#ffffff"},typography:{baseFontSizePx:16,lineHeight:1.6,scaleRatio:1.2}}};function _(e){return U[e]}function z(e){const t=_(e).palette;return[{key:"case-elective",label:"Elective",color:t.accent},{key:"case-urgent",label:"Urgent",color:t.warning},{key:"case-emergency",label:"Emergency",color:t.danger},{key:"case-success",label:"Completed",color:t.success}]}function M(e,t){const n=e.split("/").filter(Boolean),r=t.split("/").filter(Boolean);if(n.length!==r.length)return{ok:!1,params:{}};const s={};for(let d=0;d<n.length;d++){const c=n[d],a=r[d];if(c.startsWith(":"))s[c.slice(1)]=decodeURIComponent(a);else if(c!==a)return{ok:!1,params:{}}}return{ok:!0,params:s}}function u(e,t={}){return{status:200,body:e,headers:t}}function y(e){return{status:201,body:e}}function N(){return{status:204}}function l(e){return{status:400,body:{error:e}}}function h(e="Not Found"){return{status:404,body:{error:e}}}function A(e){return{status:409,body:{error:e}}}function T(e){return{status:500,body:{error:e}}}const V=[{method:"GET",pattern:"/mapping-profiles",handler:()=>u(O())},{method:"POST",pattern:"/mapping-profiles",handler:e=>{const t=e.body;if(!t||!t.name||!t.owner||!t.fieldMappings)return l("Missing required fields");const n=P({name:t.name,owner:t.owner,fieldMappings:t.fieldMappings});return y(n)}},{method:"POST",pattern:"/imports/excel",handler:e=>{const t=e.body;if(!t||!t.fileName||!Array.isArray(t.rows))return l("fileName and rows are required");const n=R(t.fileName,t.rows);return y(n)}},{method:"GET",pattern:"/backlog",handler:e=>{const{caseTypeId:t,surgeonId:n,search:r}=e.query||{},s=q({caseTypeId:t,surgeonId:n,search:r});return u(s)}},{method:"DELETE",pattern:"/backlog/:id",handler:(e,t)=>B(t.id)?N():h("Backlog item not found")},{method:"PATCH",pattern:"/backlog/:id",handler:(e,t)=>{const n=t.id,r=e.body;if(!r||Object.keys(r).length===0)return l("No fields to update");const s=C(n,r);return s?u(s):h("Backlog item not found")}},{method:"GET",pattern:"/schedule",handler:e=>{const{date:t}=e.query||{},n=E(t?{date:t}:void 0);return u(n)}},{method:"POST",pattern:"/schedule",handler:e=>{const t=e.body;if(!t||!t.waitingListItemId||!t.roomId||!t.surgeonId||!t.date||!t.startTime||!t.endTime)return l("Missing required schedule fields");try{const n=G({waitingListItemId:t.waitingListItemId,roomId:t.roomId,surgeonId:t.surgeonId,date:t.date,startTime:t.startTime,endTime:t.endTime,notes:t.notes});return y(n)}catch(n){const r=(n==null?void 0:n.message)||"Error creating schedule";return r.includes("future")||r.includes("past")?l(r):r.includes("unavailable")?A(r):T(r)}}},{method:"PATCH",pattern:"/schedule/:id",handler:(e,t)=>{const n=t.id,r=e.body;if(!r)return l("Missing body");try{if(typeof r.version=="number"){const a=v(n,r);return u(a)}const s=E().find(a=>a.id===n);if(!s)return h("Not found");const d={version:s.version};r.startTime!==void 0&&(d.startTime=r.startTime),r.endTime!==void 0&&(d.endTime=r.endTime),r.status!==void 0&&(d.status=r.status),r.notes!==void 0&&(d.notes=r.notes);const c=v(n,d);return u(c)}catch(s){const d=(s==null?void 0:s.message)||"Error updating schedule";return d.includes("Not found")?h(d):d.includes("Version conflict")?A(d):T(d)}}},{method:"DELETE",pattern:"/schedule/:id",handler:(e,t)=>($(t.id),N())},{method:"GET",pattern:"/exports/schedule",handler:e=>{const{date:t=new Date().toISOString().slice(0,10)}=e.query||{},n=H(t);return u(n)}},{method:"GET",pattern:"/legend",handler:e=>{var r;const t=((r=e.query)==null?void 0:r.theme)||"default",n=z(t);return u(n)}}];async function W(e){const t=V.find(r=>r.method===e.method&&M(r.pattern,e.path).ok);if(!t)return{status:404,body:{error:"Route not found"}};const{params:n}=M(t.pattern,e.path);try{return await t.handler(e,n)}catch(r){return T((r==null?void 0:r.message)||"Unknown error")}}export{W as handleRequest};
